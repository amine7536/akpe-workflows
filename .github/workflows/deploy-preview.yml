name: Deploy Preview

on:
  workflow_call:
    inputs:
      service_name:
        description: "Service name (e.g. backend-1, backend-2, front)"
        required: true
        type: string
      gitops_repo:
        description: "Gitops repo in owner/repo format (default: vars.GITOPS_REPO)"
        required: false
        type: string
        default: ""
    secrets:
      GITOPS_PAT:
        required: true

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: amine7536/akpe-workflows/.github/actions/deploy-preview@feat/ts-deploy-preview-action
        with:
          gitops-repo: ${{ inputs.gitops_repo || vars.GITOPS_REPO }}
          gitops-token: ${{ secrets.GITOPS_PAT }}
          service-name: ${{ inputs.service_name }}
          head-ref: ${{ github.head_ref }}
          commit-sha: ${{ github.sha }}
          pr-author: ${{ github.actor }}
          pr-url: ${{ github.event.pull_request.html_url }}
          pr-number: ${{ github.event.pull_request.number }}
          timestamp: ${{ github.event.pull_request.updated_at }}
          workflow-run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
