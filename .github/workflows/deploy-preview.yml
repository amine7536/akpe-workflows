name: Deploy Preview

on:
  workflow_call:
    inputs:
      service_name:
        description: "Service name (e.g. backend-1, backend-2, front)"
        required: true
        type: string

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          repository: amine7536/akpe-workflows
          sparse-checkout: .github/scripts

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r .github/scripts/requirements.txt

      - name: Deploy preview
        run: python .github/scripts/deploy-preview.py
        env:
          GITOPS_TOKEN: ${{ secrets.GITOPS_PAT }}
          SERVICE_NAME: ${{ inputs.service_name }}
          HEAD_REF: ${{ github.head_ref }}
          COMMIT_SHA: ${{ github.sha }}
          PR_AUTHOR: ${{ github.actor }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TIMESTAMP: ${{ github.event.pull_request.updated_at }}
          WORKFLOW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
